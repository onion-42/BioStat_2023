---
title: "HW2 Data Vis"
author: "Nadezhda Lukashevich"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(plotly)

```
### 1. Загрузите датасет life_expectancy_data.RDS (лежит в папке домашнего задания). Это данные с основными показателями, через которые высчитывается ожидаемая продолжительности жизни по метрике World Development Indicator на уровне стран2. В данных оставлены строки, относящиеся к положению женщин в 2019 г.
```{r}
df <- readRDS('life_expectancy_data.RDS')
head(df)
```
```{r}
colnames(df) <- gsub(" ", "_", colnames(df))
summary(df)
```

### 2. Сделайте интерактивный plotly график любых двух нумерических колонок. Раскрасть по колонке континента, на котором расположена страна

```{r}

fig <- plot_ly(data = df, x = ~Life_expectancy, y = ~Urban_population,color=~continent, colors = "Set1")
fig
```
### 3. Проведите тест, на сравнение распределений колонки `Life expectancy` между группами стран Африки и Америки. Вид статистического теста определите самостоятельно. Визуализируйте результат через библиотеку `rstatix`.
```{r}
ggplot(df, aes(x=Life_expectancy, color = 'Life_expectancy'))+  
  geom_histogram(aes(y = ..density..), bins = 7,  fill = '#67B7D1', alpha = 0.5) +  
  geom_density(color = '#67B7D1') +  
  geom_rug(color = '#67B7D1') + theme_classic() +
  scale_color_manual(values = c('density' = '#67B7D1'))+labs(title="Distplot for Life expectancy",
        x ="LE (years)", y = "Density")

```
```{r}
library(rstatix)

qqnorm(df$Life_expectancy, pch = 1, frame = FALSE)
qqline(df$Life_expectancy, col = "steelblue", lwd = 2)
print(df%>%shapiro_test(Life_expectancy))

# Несмотря на то, что отклонения от нормальности незначительные визуально (кроме обрезанного распределения, что и на qqплоте съезжает), тест на нормальность переменная не проходит. Т.к. это дз, я возьму MWU тест, но в реальной жизни, мне кажется, t test можно было бы тут использовать
```

```{r}
library(ggpubr)


stat.test <- df %>% filter(continent %in% c("Africa", "Americas")) %>% 
  wilcox_test(Life_expectancy ~ continent, paired = FALSE)

p <- ggboxplot(
  df %>% filter(continent %in% c("Africa", "Americas")), x = "continent", y = "Life_expectancy", 
  color = "continent", palette =c("#00AFBB", "#FC4E07"),  add = "jitter"
)
p +stat_pvalue_manual(stat.test, label = "T-test, p = {p}", 
                      y.position = 85)

# Не совсем поняла, что нужно было сделать, надеюсь, сделала верно. Отличие стат значимое, как видим, на уровне 0.05
```
### 4. Сделайте новый датафрейм, в котором оставите все численные колонки кроме `Year`. Сделайте корреляционный анализ этих данных. Постройте два любых типа графиков для визуализации корреляций.

```{r}
library(corrplot)

df_numeric <- df %>% 
  select_if(is.numeric) %>% 
  select(-Year)

correlation_matrix <- cor(df_numeric, use = "complete.obs")
```


```{r}
# Баблплот
corrplot(correlation_matrix, method="circle", type="lower", 
         tl.col="black", tl.srt=45, diag=FALSE, 
         col = COL2('PiYG'), tl.cex = 0.4)
```
```{r}
# Хитмап
corrplot(correlation_matrix, method="color", 
         tl.col="black", tl.srt=45, diag=FALSE, 
         col = COL2('PiYG'), tl.cex = 0.4)
```

  ### 5. Постройте иерархическую кластеризацию на этом датафрейме.
  
```{r}
library(stats)
library(gplots)
set.seed(42)
df_scaled <- scale(df_numeric)
d <- dist(df_scaled)
hc <- hclust(d, method = "complete")
plot(hc, cex = 0.6, hang = -1)
```
### 6. Сделайте одновременный график heatmap и иерархической кластеризации. Содержательно интерпретируйте результат.
```{r dpi=500}
mat_clipped <- pmax(pmin(as.matrix(df_scaled), 4), -4)
row.names(mat_clipped) = df$Country

heatmap.2(mat_clipped, Rowv = as.dendrogram(hc), 
          symm = FALSE, trace = "none", 
          col = bluered(20), 
          margin = c(10, 10), 
          main = "Heatmap with Hierarchical Clustering", cexRow=0.3)
```
#### Интерпретация

Признаки кластеризуются по 2-м группам: 
1) Признаки, связанные со смертностью или в дальнейшем "смертонстные" - все виды смертности попали сюда. Также сюда попали, что отчасти логично, безработица, заболеваемость туберкулезом, лечение туберкулеза и популяция деревни. Эти признаки "горят" в странах Африки и почти все понижены в ряде стран Европы. Интересно, что в ряде стран Европы сильно понижено лечение туберкулеза: это, возможно, говорит об очень низкой заболеваемости в том числе. 
2) Признаки "комфорта" в свою очередь тоже бьются на 3 группы:
- Признаки "иммунизации", которые почти у всех стран более-мене на одном уровне, кроме ряда стран Африки, Азии в самом низу плота, у которых они явно понижены
- "Городские" признаки: городская популяция, технологии и санитарные сервисы, а также, что интересно, продолжительности жизни. Видимо, эти признаки говорят о доступности базовых удобств, таких как чистая вода, и потому попали с продолжительностью жизни в один кластер. Эти фичи понижены в странах Африки и ряде стран Азии и повышены у всех остальных.
- "Экономические": ВВП, ВНД и ВВП на душу населения, а также риск суицида и кол-во мест в больницах -- достаточно контринтуитивно попали сюда. Здесь почти все страны равны, помимо ряда, видимо, крайне развитых экономик Европы, Азии, Америки, в которых признаки повышены. Риск суицида достаточно шумный признак, что говорит, возможно, о том, что причины для суицида могут быть в любой экономике. А вот кол-во койкомест в больницах повышен в ряде стран Европы, при этом не в тех же, в которых явно самые высокие экономические скоры. Возможно, это постсовесткие страны. 
Страны в свою очередь группируются на 6: 
Группа 1: "смертностная" группа признаков повышена, "иммунизация" на нормальном уровне, "городские" и "экономические" признаки снижены или на среднем уровне, в группу попало множество стран Африки.
Группа 2: повышена популяция деревни из "смертностных" признаков, остальные на среднем уровне, повышены "городские" признаки, "экономические" признаки снижены или на среднем уровне. Сюда попали страны Азии, Европы, Америк, Океании
Группа 3: понижены "смертностные" признаки, повышены "городские" и на среднем уровне "экономические". Здесь бол-во стран, видимо, из Америки
Группа 4: самые низкие "смертностные", высокие "городские" и самые высокие "экономические" - в основном страны Европы, а также немного из Америки и Азии.
Группа 5: "смертностные" признаки самые высокие, самая низкая "иммунизация", низкие "городские" признаки и средние "экономические". Сюда попали страны Африки, такие как Ангола, Конго, Южный Судан. При желании эта группа вполне себе вписывается в первую, единственное отличие это "иммунизация" и более плохие показатели в целом.
Группа 6: 2 аутлаера и один из них Китай. Одни из самых высоких "экономиечских" характеристик, из-за ВВП и ВНД, но не ВВП на душу населения. Остальные признаки на среднем уровне.


### 7. Проведите PCA анализ на этих данных. Проинтерпретируйте результат.
```{r}
row.names(df_scaled) = df$Country
pca_result <- prcomp(df_scaled, center = TRUE, scale. = TRUE)
summary(pca_result)
```
#### Интерпретация

Видим, что данные достаточно шумные, в первой компоненте всего 40% объясненной дисперсии, хотя 75% объясненной дисперсии накапливаются к всего лишь 5-й компоненте. 
```{r}
plot(pca_result, type = "lines")

```
По графику локтя перелом происходит уже на 2-й компоненте.
```{r}
library(factoextra)
fviz_pca_biplot(pca_result,
                label="var",
                habillage = df$continent)+theme_classic()

```
#### Интерпретация

Видим, что первые две компоненты PCA, хотя не очень сильно информативные (в первой всего 40% объясненной дисперсии), похожим образом группируют характеристики: иммунизационные признаки формируют вектора с одним направлением, как и смертности, кроме суицида. Страны Африки, в основном группируются в направдении повышения "смертностных" признаков и в сторону от "иммунизации". Страны Европы группируются в месте роста "экономических". Кстати, что интересно, PCA более логично сгруппировал количество больничных мест вместе с другими признаками "комфорта" - наличием очистительных технологий и санитарии. Америки группируются в центре, т.е. не совсем объясняются компонентами. Здесь "аутлаером" является США, точка в крайне правой верхней части графика. Одна из стран Америки, также отстоит от других в левой верхней части. Страны Азии разнесены по первой компоненте и не образуют определенную группу. То же можно сказать об Океании, она находится посередине с тильтом влево вниз (по вектору деревенского населения). Но эти гипотезы мы также в дальнейшем подтвердим или опровергнем, построив биплот в плотли.


### 8. Постройте biplot график для PCA. Раскрасьте его по значениям континентов. Переведите его в `plotly`. Желательно, чтобы при наведении на точку, вы могли видеть название страны.

```{r}
loadings <- pca_result$rotation[, 1:2]
loadings <- data.frame(Variable = rownames(loadings), loadings)
scaling_factor <- 3  #для лучшей визуализации

biplot_data <- data.frame(PC1 = pca_result$x[,1], 
                          PC2 = pca_result$x[,2], 
                          Continent = df$continent,
                          Country = df$Country)

p <- ggplot() +
  geom_point(data = biplot_data, aes(x = PC1, y = PC2, color = Continent, text = Country)) +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor), arrow = arrow(type = "closed", length = unit(0.2, "inches")), color = "black") +
  geom_text(data = loadings, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = Variable), hjust = 1.1, vjust = 1.1) +
  theme_classic()

ggplotly(p, tooltip = "text")

```
### 9. Дайте содержательную интерпретацию PCA анализу.
#### Интерпретация

Вооружившись оптикой плотли, проанализируем результат с учетом выдвинутых ранее гипотез: 
1. Страны Африки
- Страны из самого "плохого" кластера преимущественно концентрируются в верхнем левом углу
- Североафриканские страны в основном концентрируются в центре
- Другие образуют облако слева внизу, не так далеко слева, как первые
2. Cтраны Америки
- 2 аутлаера: США, самая правая сверху, и Гаити, слева сверху. 
- Остальные, в основном, концентрируются всередине, с небольшим сдвигом вправо. Интересно, что одни из самых бедных стран Америки, Боливия и Венесуэла, сдвинуты влево вверх, но не отстают слишком далеко от других, как например Гаити. 
3. Страны Азии
- В основном образуют единое облако, разнесенное по оси X: самая правая точка - Япония, левая - Афганистан. Китай не является явным аутлаером, как по результатам кластеризации. В целом можно разделить страны на:
- более "центровые" (н-р Малазия, Ирак, Иордан, КНДР, Индия), 
- больше "справа сверху" (Япония, Китай, Корея, Сингапур -- практически группа дальневосточной Азии, кроме КНДР), 
- больше "слева сверху" вместе с группой 5 Африки (Сирия, Филиппины, Йемен, Пакистан, Афганистан -- крайне разнородная группа, но отчасти объединена наличием недавних войн, кроме Филиппин и Пакистана - хотя последняя известна потухшим индо-пакистанским конфликтом) 
- и больше "слева снизу" (Мьянма, Непал, Камбоджа, Бангладеш - буддисткие южноазиатские страны, крайне бедные). 
4. Страны Европы
- Выделяется группа концентрирумая справа сверху - страны западной Европы, а также часть пост-советских, например Россия, страны Балтии, Беларусь
- Также облако чуть правее центра: страны пост-советские или из советского блока: Румыния, Украина, сербия, Грузия, Армения, Северная Македония. Видимо, чуть более бедные страны с теми же тенденциями, что в первой группе, т.к. как будто они идут немного параллельно. 
- "Маленькие" страны: неожиданно, Лихтенштейн, Косово -- регион располагающийся наиболее слева среди европейских, Черногория, острова: Фареры и Нормандские, а также Босния и Герцеговина.
5. Страны Океании
- Аутлаер Папуа Новая Гвинея
- Остальные деляться на группы: 
- наиболее справа - Австралия, Новая Зеландия, и неожиданно Бруней, хотя предыдущие значительно ближе друг к другу; 
- наиболее сверху: Гуам, Новая Каледония, Французская полинезия - территории Франции или США в океании; 
- остальные находятся слева и разнесены по оси Y


### 10. Сравните результаты отображения точек между алгоритмами PCA и UMAP.

```{r}
library(umap)

umap_result <- umap(df_scaled)
df_umap <- data.frame(UMAP1 = umap_result$layout[,1], UMAP2 = umap_result$layout[,2], continent = df$continent, Country=df$Country)
p_umap <- ggplot(df_umap, aes(x = UMAP1, y = UMAP2, color = continent, text = Country)) +
geom_point() +
ggtitle("UMAP")+theme_classic()


ggplotly(p_umap, tooltip = "text")

```
#### Интерпретация

В целом, результаты PCA и UMAP похожи. Однако UMAP сблизил некоторые страны, сделав примерно 4 кластера: 
1) Наиболее богатые страны Америки (США, Канада, но также Куба и Барбадос), Океании (Австралия, Новая Зеландия), Восточной Европы (страны Балтии, РФ, Сербия, Польша), вся Западная Европа, кроме Лихтенштейна - справа внизу
2) Практически все азиатские страны, средняя азия, арабский мир, южная азия - кроме наиболее бедных; страны Кавказа, страны северной африки: как Турция, так и Морокко, а также бол-во стран латинской америки. 
3) "Маленькие" cтраны: Лихтенштейн, Косово, подконтрольные маленькие территории Франции, США, и Китая, Суринам (наименьшая страна Южной Америки), Аруба (небольшой остров), маленькая Гаяна (соседка Суринама). Единственная страна, кто выбивается - это Индия, что, видимо, говорит о достаточно плохих показателях, т.к. эта страна с огромным населением и территорией, но показателями, близкими к маленьким, островным, подконтрольным другим странам государствам. Эта группа чуть слева сверху.
4) Все остальные страны Африки, а также беднейшние страны Азии и Океании, и Гаити. Группа в левом верхнем углу. 

Мне кажется, UMAP сформировал крайне логичные и легко интерпретируемые кластеры, лучше, чем PCA, однако расходимость с PCA в, например, группировке африканских стран, говорит о том, что эти выделенные кластера не являются очень робастными. 

### 11. Давайте самостоятельно увидим, что снижение размерности – это группа методов, славящаяся своей неустойчивостью. Удалите 5 случайных колонок. Проведите PCA анализ. Повторите результат 3 раза. Наблюдаете ли вы изменения в куммулятивном проценте объяснённой вариации? В итоговом представлении
данных на биплотах? С чем связаны изменения между тремя PCA?
```{r}

perform_pca <- function(data) {
  pca_result <- prcomp(data, center = TRUE, scale. = TRUE)
  print(summary(pca_result))
  df_pca <- data.frame(PC1 = pca_result$x[,1], PC2 = pca_result$x[,2])
  ggplotly(ggplot(df_pca, aes(x = PC1, y = PC2, color = df$continent, text = df$Country)) + geom_point() +theme_classic(), tooltip = "text")
}

# эксперимент три раза
plots <- list()
for (i in 1:3) {
  cols_to_remove <- sample(colnames(df_scaled), 5)
  df_reduced <- df_scaled[, !(colnames(df_scaled) %in% cols_to_remove)]
  plots[[i]] <- perform_pca(df_reduced)
}
subplot(plots)
```
#### Интерпретация

В целом, видим что общая тенденция, н-р концентрация Африканских и Европейских стран в разных частях биплотов сохраняется, однако ряд других выделенных тенденций на "полном" PCA, например очевидно разделенные кластера Африканских стран или кластер "маленьких" стран выделяются далеко не всегда. Думаю, такой метод "бутстраппинга" PCA может помочь разделить тенденции реально существующие, и появляющиеся с ходе "оверфиттинга" аналитика, смотрящего на плот. Во всех итерациях самой информативной была первая компонента, в районе 35-40% объясненной дисперсии, а 75% достигалась на 5-й компоненте.

### 12. Давайте самостоятельно увидим, что снижение размерности – это группа методов, славящаяся своей неустойчивостью. Создайте две дамми-колонки о том: (1) принадлежит ли страна к африканскому континенту, (2) Океании. Проведите PCA вместе с ними, постройте биплоты. Проинтерпрейтируйте результат. Объясните, почему добавление дамми-колонок не совсем корректно в случае PCA нашего типа.

```{r}
df_scaled_with_dummies <- cbind(df_scaled, Is_Africa = as.numeric(df$continent == "Africa"), Is_Oceania = as.numeric(df$continent == "Oceania"))
pca_result_with_dummies <- prcomp(df_scaled_with_dummies, center = TRUE, scale. = TRUE)

```


```{r}
loadings <- pca_result_with_dummies$rotation[, 1:2]
loadings <- data.frame(Variable = rownames(loadings), loadings)

biplot_data <- data.frame(PC1 = pca_result_with_dummies$x[,1], 
                          PC2 = pca_result_with_dummies$x[,2], 
                          Continent = df$continent,
                          Country = df$Country)

p <- ggplot() +
  geom_point(data = biplot_data, aes(x = PC1, y = PC2, color = Continent, text = Country)) +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor), arrow = arrow(type = "closed", length = unit(0.2, "inches")), color = "black") +
  geom_text(data = loadings, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = Variable), hjust = 1.1, vjust = 1.1) +
  theme_classic()

ggplotly(p, tooltip = "text")
```
```{r}
summary(pca_result_with_dummies)
```

#### Интерпретация

По идее, PCA предполагает линейные взаимосвязи между переменными и лучше всего работает с непрерывными переменными. Поэтому добавление бинарных данных теоретически некорректно, так как PCA будет пытаться интерпретировать эти бинарные значения как непрерывные. Однако у меня, несмотря на то, что соответствующие собственные вектора отображаются на плоте и саммари результатов явно обновилось, положение точек практически не изменилось на биплоте. Видимо, вклад других переменных в первые две компоненты крайне велик так, что добавление бинарных мало влияет. Возможно, если бы мы добавили категориальную переменную, которая вносила бы значительный вклад в первые компоненты, это бы привело к искажению данных.

