---
title: "clin_data_hw"
output:
  html_document: default
  pdf_document: default
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warnings=FALSE)
library(tidyverse)
```
# Описание данных
Вам предоставлен файл «trauma.xlsx», который содержит следующие данные:
• id – номер пациента в списке
• Name – имя фамилия пациента
• Sex – пол пациента
• Age – возраст пациента (лет)
• Height – рост пациента (дюймы, 1 дюйм – 2.54 см)
• Weight – масса тела пациента (фунты, 1 кг – 2.2 фунта)
• SBP – систолическое артериальное давление при поступлении (мм рт.ст.)
• DBP – диастолическое артериальное давление при поступлении (мм рт.ст.)
• FOUR – балл по шкале комы FOUR при поступлении
• GSC – балл по шкале комы Глазго при поступлении
• Hb – уровень гемоглобина при поступлении (г/дл)
• Death – летальный исход в течение 24 часов (1 – наступил, 0 – нет)
Это полностью сгенерированный учебный датасет, но давайте представим, что это данные
пациентов, госпитализированных в больницу после получения черепно-мозговой травмы вследствие падения с электросамоката.

# Загрузите датасет из файла «trauma.xlsx»

```{r reading}
library(readxl)

data <- read_excel("trauma.xlsx")
glimpse(data)
```
```{r nans}
# Убедимся, что пропущенных значений нет. Видим, что по всем переменным доступно 100% данных
library(naniar)
vis_miss(data)
```


```{r cleaning}
# Прежде чем дать описательную статистику, переведу Height в численный вид и удалю колонку "...1", а также переведу категории в факторы. Как я поняла, шкалы являются численными, поэтому их переводить не будем. 
# Также переведу Height и Weight в метрическую систему (см и кг соответственно).

data <- data %>% select(-`...1`)%>%
  mutate(
    Height = as.numeric(gsub('\"', '', Height))*2.54,
    Weight = Weight/2.2,
    id = as.factor(id),
    Name = as.factor(Name),
    Sex = as.factor(Sex),
    Death = as.factor(Death)
  )

glimpse(data)

```
# Задание 1 
1. Дайте описательную статистику для переменных, включённых в датасет. Дополнительно рассчитайте, у какого количества пациентов и в каком проценте случаев у пациентов был снижен уровень гемоглобина? Используйте следующие референтные значения (Мужчины: 13.5–16 г/дл, Женщины: 12–14 г/дл).

- Давайте посмотрим на описательную статистику по группам: сначала по полу, как одной из важных групп, и затем по исходам, которые в дальнейшем будем предсказывать
```{r descr_stats}
library(gtsummary)
# Описательная статистика по полу
data_for_summary <- data %>%
  mutate(
    id_status = ifelse(duplicated(id) | duplicated(id, fromLast = TRUE), "Repeated", "Unique"),
    Name_status = ifelse(duplicated(Name) | duplicated(Name, fromLast = TRUE), "Repeated", "Unique")
  ) %>%
  select(-id, -Name)


table_summary <- data_for_summary %>%
  tbl_summary(
    by = Sex,
    type = all_continuous() ~ "continuous2",
    missing = "no",
    statistic = list(
      all_continuous() ~ c("{median}({IQR})","{mean}±{sd}", "{min}; {max}"), 
      all_categorical() ~ "{n}({p}%)" 
    )
  ) %>% 
  add_overall() %>% 
  add_n() %>% 
  add_p(include = -id_status) %>%  # Исключение переменной id_status из расчета p-значений, поскольку выдается ошибка: все значения уникальны
  modify_header(label = "**Переменные**") %>% 
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Описательная статистика по полу**")%>%   modify_footnote(
    all_stat_cols() ~ "Median (IQR), Mean±std, Min; Max, or N(Frequency)"
  ) 


table_summary
```
- Комментарий: Видим, что мужчин значительно больше, чем женщин. Средний возраст 41, и он не различается между группами. Рост, как и ожидается, значимо выше у мужчин. Средний вес составляет 88 кг и он также ожидаемо значимо выше у мужчин. Среднее систолическое АД у пациентов составляет 111 мм рт.ст., диастолическое 85 мм рт.ст и эти характеристики не различаются по полу. То же можно сказать про шкалы комы: для FOUR среднее значение 8.9, а для шкалы Глазго 7.79. Уровень гемоглобина же значимо выше у мужчин, в среднем 12.8 г/дл. В численных переменных не наблюдается странных минимальных и максимальных значений - выбросов. Исходы не отличаются по группам, что хорошо для дальнейших сравнений. Все id уникальны, как и почти все имена.

```{r descr_stats_death}
# Описательная статистика по исходам
data_for_summary <- data %>%
  mutate(
    id_status = ifelse(duplicated(id) | duplicated(id, fromLast = TRUE), "Repeated", "Unique"),
    Name_status = ifelse(duplicated(Name) | duplicated(Name, fromLast = TRUE), "Repeated", "Unique")
  ) %>%
  select(-id, -Name)


table_summary <- data_for_summary %>%
  tbl_summary(
    by = Death,
    type = all_continuous() ~ "continuous2",
    missing = "no",
    statistic = list(
      all_continuous() ~ c("{median}({IQR})","{mean}±{sd}", "{min}; {max}"), 
      all_categorical() ~ "{n}({p}%)" 
    )
  ) %>% 
  add_overall() %>% 
  add_n() %>% 
  add_p(include = -id_status) %>%  # Исключение переменной id_status из расчета p-значений, поскольку выдается ошибка: все значения уникальны
  modify_header(label = "**Переменные**") %>% 
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Описательная статистика**")%>%   modify_footnote(
    all_stat_cols() ~ "Median (IQR), Mean±std, Min; Max, or N(Frequency)"
  ) 


table_summary
```
- Комментарий: видим, что демографические и антропометрические характеристики, такие как Пол, Возраст, Рост, Вес не являются предсказательными для исхода. Группа с летальным исходом характеризуется значимо пониженными систолическим и диастолическим давлением, пониженными шкалами Глазго и FOUR, а также пониженным гемоглобином. Это может говорить о тяжелом состоянии пациентов со скорым летальным исходом.

```{r low hb}
# Расчет количества и процента пациентов с сниженным уровнем гемоглобина
data$Low_Hb <- with(data, (Sex == 'Male' & Hb < 13.5) | (Sex == 'Female' & Hb < 12))
low_hb_count <- sum(data$Low_Hb)
low_hb_percent <- (low_hb_count / nrow(data)) * 100

cat("Количество пациентов с сниженным уровнем гемоглобина:", low_hb_count,"\n")
cat("Процент пациентов с сниженным уровнем гемоглобина:", low_hb_percent, "%","\n")

```

- Комментарий: почти у половины пациентов наблюдается сниженный уровень гемоглобина при поступлении в больницу. Это может свидетельствовать о потере крови среди пострадавших.

# Задание 2
2. Рассчитайте индекс массы тела у пациентов (кг / м2). Каков был средний (M (SD)) уровень ИМТ у пациентов, включённых в исследование? Какая доля пациентов имела ожирение (ИМТ> 30)?

```{r bmi}
data <- data %>%
  mutate(
    BMI = Weight / (Height / 100)^2
  )

mean_BMI <- mean(data$BMI)
sd_BMI <- sd(data$BMI)

obesity_rate <- sum(data$BMI > 30) / nrow(data)

cat("Средний ИМТ: ", mean_BMI, "(", sd_BMI, ")\n")
cat("Доля пациентов с ожирением (ИМТ > 30): ", obesity_rate*100, "%\n")

```

- Комментарий: средний ИМТ находится в пределах нормы, лишь у 6.9% пациентов наблюдаем ожирение. Это может быть ожидаемо, поскольку мы имеем дело с активной популяцией: даже несмотря на то, что электросамокат автоматический, им может быть сложно управлять с большим весом и при этом оставаться в балансе.

# Задание 3
3. Как выглядит ROC-кривая для предсказания летального исхода в течение 24 часов по
переменной, характеризующей уровень гемоглобина? Постройте график. Чем может быть
обусловлена такая форма кривой?

```{r roc}
library(pROC, quietly = TRUE)

roc_curve <- roc(data$Death, data$Hb, quiet = TRUE)

plot(roc_curve, main = "ROC кривая для предсказания смерти по уровню гемоглобина")

```

- Комментарий: мы видим, что уровень гемоглобина при поступлении не очень хорошо, но положительно коррелирует с исходом - смертью в течение 24-х часов. Это может говорить о том, что часть пациентов могла иметь потерю крови и соответственно это могло приводить к скорому уходу из жизни. С другой стороны, часть пациентов могла изначально иметь низкий гемоглобин, а также потеря крови могла быть вовремя остановлена - это могут быть причины неидеального предсказания исхода. 

# Задание 4 
4. Чему равна площадь под ROC-кривой, которую вы построили в вопросе 3? Чему равен 95% двусторонний ДИ для площади под ROC-кривой, которую вы построили в вопросе 3?

```{r auc}
auc_value <- auc(roc_curve)
auc_ci <- ci(roc_curve, level = 0.95)

cat("Площадь под ROC-кривой (AUC):", auc_value, "\n")
cat("95% ДИ для AUC:", auc_ci[1], "-", auc_ci[3], "\n")
```

- Комментарий: судя по нижней границе ДИ, уровень гемоглобина действительно неслучайно ассоциирован с исходом, и, возможно, сделанные нами выводы имеют место быть. Площадь под кривой составляет 0.7, что является не очень высоким показателем, но все еще показывает положительную ассоциацию между переменными.

# Задание 5
5. Проведите ROC-анализ и определите, какое пороговое значение является оптимальным для предсказания летального исхода в течение 24 часов по шкале комы Глазго. Какой чувствительностью и специфичностью обладает данный порог?

```{r youden}
roc_curve <- roc(data$Death, data$GSC, quiet = TRUE)
coords <- coords(roc_curve, "best", ret = c("threshold", "sensitivity", "specificity"), best.method = "youden")

cat("Оптимальный порог (по индексу Юдена):", coords$threshold, "\n")
cat("Чувствительность:", coords$sensitivity, "\n")
cat("Специфичность:", coords$specificity, "\n")

```

- Комментарий: Оптимальный порог 7.5 для шкалы Глазго, которая варьируется от 3 (наихудший возможный результат, глубокая кома) до 15 (ясное сознание), указывает на тяжелое ухудшение состояния сознания пациента у пациентов с летальным исходом - поскольку мы знаем, что эта группа имеет значимо пониженный балл по данной шкале. Начиная с 8 баллов значение шкалы можно интерпретировать как наличие тяжелого повреждения, что согласуется с нашим результатом.

- Высокая чувствительность (0.86) означает, что шкала GCS эффективно определяет большую часть пациентов, у которых риск летального исхода высок.

- Хорошая специфичность (0.81) говорит о том, что шкала также достаточно хорошо исключает пациентов с низким риском летального исхода.

# Задание 6
6. Какая из количественных переменных в датасете (включая рассчитанный вами ранее ИМТ) обладает наибольшей площадью под ROC-кривой? Как вы можете интерпретировать это знание? Какая количественная переменная имеет наименьшую площадь?
```{r best_auc}

numeric_vars <- data %>% select(where(is.numeric))
auc_results <- data.frame(Variable = character(), AUC = numeric())

for (var in names(numeric_vars)) {
  roc_result <- roc(data$Death, numeric_vars[[var]], quiet = TRUE)
  auc_value <- auc(roc_result)
  auc_results <- rbind(auc_results, data.frame(Variable = var, AUC = auc_value))
}

max_auc <- auc_results[which.max(auc_results$AUC), ]
min_auc <- auc_results[which.min(auc_results$AUC), ]

cat("Переменная с максимальным AUC:", max_auc$Variable, "- AUC:", max_auc$AUC, "\n")
cat("Переменная с минимальным AUC:", min_auc$Variable, "- AUC:", min_auc$AUC, "\n")

```
```{r}
# Ради интереса также посмотрим на остальные результаты аука
arrange(auc_results, AUC)
```
- Комментарий: Видим, что шкала FOUR имеет лучшую предсказательную способность из всех переменных, AUC = 0.93. Важно отметить, что у шкалы Глазго она также отличная (AUC = 0.91). Переменные, описывающие клинические показатели: уровень гемоглобина и давление, также положительно ассоциированны с исходом, но в значительно меньшей степени (от 0.7 до 0.79). Это можно интерпретировать как то, что шкалы комы учитывают в себе гораздо больше важных для предсказания признаков, и, возможно, поэтому являются более качественными предикторами. Шкала FOUR при этом является лучшей моделью для предсказания летального исхода, чем шкала Глазго, возможно это связано с назначениями шкал, их новизной, подтвержденностью или другими факторами. 

- Минимальное значение получил рост - 0.48. Мы знаем, что он выше у мужчин, но при этом исходы распределены равномерно между полами. Поэтому можно заключить, что антропометрические показатели, такие как рост, а также ИМТ (AUC = 0.5) и вес (AUC = 0.52) являются неинформативными для предсказания смерти, поскольку их предсказательная способность практически не отличается от таковой для случайного предиктора. То же можно сказать о показателе, который обычно значительно связан с исходом - возрасте (AUC = 0.52). Это может говорить о том, что смерть в ближайшие 24 часа из-за ЧМТ обуславливается другими факторами: тяжестью травмы, что, например, может быть связано с рисковым поведением, примерно одинаковым для нашей возрастной группы, скоростью доставки пациента в больницу, что может быть случайным фактором или быть обусловлено достатком пациента - этого показателя у нас нет, и другими.

